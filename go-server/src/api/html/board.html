<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAIS SCRUMLR</title>
</head>

<body>

  <h1>BOARD {{.ID}}</h1>

  <button onclick="addColumnFirst()">Add new first column</button>
  <button onclick="addColumnLast()">Add new last column</button>
  <button onclick="deleteBoard()">Delete board</button>

  <ul id="events"></ul>

  <script>
    const events = document.getElementById("events")
    const boardID = "{{.ID}}"

    fetch(`/boards/${boardID}/participants`, {
      method: 'POST',
      redirect: "manual"
    }).then(() => {
      const ws = new WebSocket(`ws:\/\/localhost:8080/boards/${boardID}`)
      ws.onopen = (evt) => {
        console.log("connected", evt)
      }
      ws.onclose = (evt) => {
        console.log("closed", evt)
      }
      ws.onerror = (evt) => console.log('ERROR: ', evt)
      ws.onmessage = (evt) => {
        console.log("received", evt)
        const li = document.createElement("li")
        li.innerText = evt.data
        const parsed = JSON.parse(evt.data)
        if (parsed.type === 'REQUEST_UPDATED') {
          const acceptButton = document.createElement("button")
          acceptButton.onclick = () => updateSessionRequest(boardID, parsed.data.user.id, "ACCEPTED")
          acceptButton.innerHTML = "Accept"
          li.append(acceptButton)
          const rejectButton = document.createElement("button")
          rejectButton.onclick = () => updateSessionRequest(boardID, parsed.data.user.id, "REJECTED")
          rejectButton.innerHTML = "Reject"
          li.append(rejectButton)
        }
        events.append(li)
      }
    })

    const updateSessionRequest = (boardID, userID, status) => {
      fetch(`/boards/${boardID}/requests/${userID}`, {
        method: 'PUT',
        body: JSON.stringify({
          status,
        })
      })
    }

    const addColumnFirst = () => {
      fetch(`/boards/${boardID}/columns`, {
        method: 'POST',
        body: JSON.stringify({
          name: "First column",
          visible: false,
          rank: 0
        })
      })
    }

    const addColumnLast = () => {
      fetch(`/boards/${boardID}/columns`, {
        method: 'POST',
        body: JSON.stringify({
          name: "Last column",
          visible: true
        })
      })
    }

    const deleteBoard = () => {
      fetch(`/boards/${boardID}`, {
        method: 'DELETE'
      })
    }
  </script>

</body>

</html>